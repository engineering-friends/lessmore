# Contributing guide

- [Настройка монорепы](#настройка-монорепы)
- [Структура веток и коммитов](#структура-веток-и-коммитов)
- [Формат коммитов и пулл реквестов](#формат-коммитов-и-пулл-реквестов)
- [Проверки перед коммитом](#проверки-перед-коммитом)
  - [Проверка на стиль](#проверка-на-стиль)
  - [Проверка на секреты](#проверка-на-секреты)
  - [Проверка на большие файлы](#проверка-на-большие-файлы)
  - [Проверка на DO-NOT-SUBMIT](#проверка-на-DO-NOT-SUBMIT)

# Настройка монорепы

Для macos лежит [здесь](https://github.com/engineering-friends/lessmore/blob/master/docs/settings.md).

# Структура веток и коммитов

- `master` - основная и единственная обязательная системная ветка, где лежит актуальный код
- Побочные ветки (`side branches`) создаются в свободной форме. В основном они являются временными и используются для разработки. При завершении работы с веткой, либо удаляем ее, либо мерджим в `master` с помощью pull request (после чего она автоматически удалится)

# Формат коммитов и пулл реквестов

- Коммиты должны называться определенным образом **только в master ветке**. Во всех остальных ветках формат коммитов свободный.
- При мёрдже пулл реквеста все коммиты сквошатся, и в мастер попадает один коммит.
- Ничего страшного, если вы ошибетесь в нейминге, но в будущем по-аккуратнее :)


Формат является вариацией общепринятых [конвенциональных коммитов](https://www.conventionalcommits.org/en/v1.0.0/).

Язык можно использовать как английский, так и русский.

```
<type>[(optional scope)]: <description>

[optional body]

[optional footer(s)]

[optinal "<Key>: <value>" records]
```

- Порядок ключей в `"<Key>: <value>"` не важен, ключи могут повторяться.
- В качестве `type` мы используем:
  - `feat`: добавление новых фич
  - `fix`: исправление багов
  - `chore`: релизы, изменение настроек тулинга, не затрагивающее код
  - `test`: изменения в тестах, не затрагивающие основной код
  - `refactor`: рефакторинг кода
  - `perf`: улучшение производительности
  - `revert`: ревёрт предыдущего коммита
  - `docs`: обновление документации
  - `style`: исправление форматирования кода или ошибок линтера
  - `deploy`: изменения конфигурации деплоймента (helm чартов, kubernetes файлов) для одно из окружений
- `scope` *(optional)* имеет формат `<entity>(.<sub_scope_1>.<sub_scope_2>. … .<sub_scope_N>)`.
  - `entity` - название сервиса/библиотеки/… Если настраиваем репозиторий, указываем `monorepo`.
  - Если хотим указать несколько scopes, то можно указать их через запятую или через `multiple_scopes`, а сами scopes в описании в блоке `"<Key>: <value>"`: `"Scopes: <scope1>, <scope2>, ..."`
  - Примеры
    - `my-service`
    - `my-service.my_sub_scope`
    - `my_lib`
    - `my_lib.my_sub_scope`
    - `monorepo`
    - `monorepo.my_sub_scope`
    - `my-service, my-lib`
    - `multiple_scopes`

# Проверки перед коммитом

Мы используем автоматически проверки перед коммитом, чтобы случайно не запушить ничего лишнего. Если что-то не так - при коммите возникнет ошибка, и в логах можно будет почитать, что не так. 

Настройки лежат в файле `.pre-commit-config.yaml`.

## Проверка на стиль
- 
- `black`: `black --line-length 120`
- `isort`: `isort --settings-path <MONOREPO_PATH>/pyproject.toml`

## Проверка на секреты

Проверка на запушенные пароли и другие секреты.

### Обработка ложно-положительных распознаваний

Для ложно-положительных распознаваний можно указать в строке с не-секретом комментарий `# pragma: allowlist secret` и проверка пройдет.

Примеры:

```secret =  2eiorasd0f7``` - такое не пройдет.

```not_a_secret =  2eiorasd0f7 # pragma: allowlist secret``` - такое пройдет

Если вы запушили большие файлы в которых много-много ложно-положительных результатов, то можно разрешить сразу все секреты для текущих файлов. Для этого из корня монорепы запустите команду
```detect-secrets scan > .secrets.baseline```. Она обновит файл `.secrets.baseline`. Этот файл нужно запушить вместе с другими файлами.

## Проверка на большие файлы

При попытке запушить в git большой файл (файл больше 200кб) `pre-commit` выдаст ошибку (check-added-large-files). Для исправления ошибки нужно добавить файл в git lfs. Для этого создайте новую строку в файле .gitattributes типа `<path_pattern> filter=lfs diff=lfs merge=lfs -text` (все строки в файле имеют этот формат).

Можно указать прямой путь к файлу или сразу шаблон названия файлов. `*` означает произвольные символы в названии файла/директории. `**` означает произвольные директории.

Примеры

- `source/python/services/airflow-etl/my_file.txt filter=lfs diff=lfs merge=lfs -text` - добавить `my_file.txt`
- `source/python/services/airflow-etl/*.txt filter=lfs diff=lfs merge=lfs -text` - добавить все `.txt` файлы из папки airflow-etl
- `**/*.txt filter=lfs diff=lfs merge=lfs -text` - добавить все `.txt` файлы из репозитория
- `**/resources/**/* filter=lfs diff=lfs merge=lfs -text` - добавить все файлы в папках `resources`

Часто такие файлы также нужно добавить в `.gitignore` в специальную секцию git lfs. Там используются аналогичные паттерны.

## Проверка на D0 N0T SUBMIT

Если вы меняете что-то в коде, что очень не хотите запушить в прод (например, прям в внутри рабочего кода что-то меняете для тестов), можно указать в этом месте комментарий `# D0 N0T SUBMIT` (только через O). Такой файл нельзя будет закоммитить.
